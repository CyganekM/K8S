name: Pod Monitor with Telegram Alerts

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-pods:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH and check pods
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_rsa \
              -J ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }}:${{ secrets.BASTION_PORT }} \
              ${{ secrets.K8S_NODE_USER }}@${{ secrets.K8S_NODE }} \
              "kubectl get pods -A --field-selector=status.phase!=Running" > failing_pods.txt

      - name: Send Telegram alert
        run: |
          if [ -s failing_pods.txt ]; then
            FAILING_PODS=$(cat failing_pods.txt)
            curl -s -X POST \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=‚ùå K8s Pod Alert: Failed pods detected: $FAILING_PODS"
          else
            echo "All pods healthy"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa failing_pods.txt